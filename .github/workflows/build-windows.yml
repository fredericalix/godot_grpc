name: Build Windows

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type (Release or Debug)'
        required: false
        default: 'Release'
        type: choice
        options:
          - Release
          - Debug

jobs:
  build-windows:
    name: Build Windows
    runs-on: windows-2022
    timeout-minutes: 120
    strategy:
      matrix:
        build_type: [Release]  # Only Release - Debug has runtime library conflicts with godot-cpp
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup vcpkg binary cache
        uses: actions/cache@v4
        with:
          path: |
            C:\vcpkg\installed
            C:\vcpkg\packages
            C:\vcpkg\buildtrees
          key: vcpkg-${{ runner.os }}-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            vcpkg-${{ runner.os }}-

      - name: Install vcpkg
        shell: pwsh
        run: |
          git clone https://github.com/microsoft/vcpkg.git C:\vcpkg
          C:\vcpkg\bootstrap-vcpkg.bat
          echo "VCPKG_ROOT=C:\vcpkg" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Clone godot-cpp
        run: |
          git clone https://github.com/godotengine/godot-cpp
          cd godot-cpp
          git checkout 4.3

      - name: Configure CMake
        shell: pwsh
        run: |
          mkdir build
          cd build
          cmake .. `
            -DCMAKE_TOOLCHAIN_FILE="C:\vcpkg\scripts\buildsystems\vcpkg.cmake" `
            -DVCPKG_TARGET_TRIPLET=x64-windows `
            -DUSE_VCPKG=ON `
            -G "Visual Studio 17 2022" `
            -A x64

      - name: Build
        shell: pwsh
        run: |
          cd build
          cmake --build . --config ${{ matrix.build_type }} -j 2

      - name: List build output
        shell: pwsh
        run: |
          Write-Host "Build output directory contents:"
          Get-ChildItem -Recurse demo/addons/godot_grpc/bin/windows/ -ErrorAction SilentlyContinue | Format-Table Name, Length, LastWriteTime

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-x86_64-${{ matrix.build_type }}
          path: demo/addons/godot_grpc/bin/windows/*
          retention-days: 7
          if-no-files-found: error

      - name: Test library can be loaded
        shell: pwsh
        run: |
          $dllPath = "demo/addons/godot_grpc/bin/windows/libgodot_grpc.windows.template_${{ matrix.build_type == 'Release' && 'release' || 'debug' }}.x86_64.dll"
          if (Test-Path $dllPath) {
            Write-Host "✓ DLL found at: $dllPath"
            $fileInfo = Get-Item $dllPath
            Write-Host "  Size: $($fileInfo.Length) bytes"
            Write-Host "  Modified: $($fileInfo.LastWriteTime)"
          } else {
            Write-Host "✗ DLL not found at expected path: $dllPath"
            Write-Host "Searching for DLL files:"
            Get-ChildItem -Recurse -Filter "*.dll" demo/ -ErrorAction SilentlyContinue
            exit 1
          }
